<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂單管理系統 - 齊貨提醒版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-待取貨 { border-left: 5px solid #F59E0B; background-color: #FFFBEB; }
        .status-已取貨 { border-left: 5px solid #10B981; background-color: #F0FDF4; }
        .status-已寄出 { border-left: 5px solid #9CA3AF; background-color: #F9FAFB; }
        .badge-待取貨 { background: #FEF3C7; color: #92400E; }
        .badge-已取貨 { background: #D1FAE5; color: #065F46; }
        .badge-已寄出 { background: #F3F4F6; color: #374151; }
        .loc-蝦皮 { border: 1px solid #EA580C; color: #EA580C; background: #FFF7ED; }
        .loc-7-11 { border: 1px solid #16A34A; color: #16A34A; background: #F0FDF4; }
        .loc-全家 { border: 1px solid #2563EB; color: #2563EB; background: #EFF6FF; }
        .loc-宅配 { border: 1px solid #7C3AED; color: #7C3AED; background: #F5F3FF; }
        /* 齊貨變色效果 */
        .all-ready { background-color: #FEF2F2 !important; border: 2px solid #FCA5A5 !important; }
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20 font-sans text-gray-900">

    <div class="max-w-6xl mx-auto p-4 space-y-6">
        <div class="flex items-center justify-between bg-white p-4 rounded-2xl shadow-sm border border-gray-200">
            <h1 class="text-xl font-black text-blue-600 tracking-tighter">ORDER MANAGER PRO</h1>
            <div class="flex space-x-2">
                <button onclick="switchView('active')" id="btn-active" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold">進行中</button>
                <button onclick="switchView('history')" id="btn-history" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-xl text-xs font-bold">歷史訂單</button>
                <button onclick="loadOrders()" class="text-blue-600 p-2">↻</button>
            </div>
        </div>

        <section class="bg-indigo-900 text-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-xs font-bold uppercase tracking-widest mb-4 opacity-70">未取貨清單統計 (按物流點)</h2>
            <div id="summary-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                </div>
        </section>

        <section id="add-section" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200 active-only">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4 text-sm">
                    <p class="font-bold text-gray-400 text-[10px] uppercase tracking-widest">客戶及收件資料</p>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="custName" placeholder="客人名稱" class="border-b p-2 outline-none focus:border-blue-500">
                        <select id="source" class="border-b p-2 outline-none"><option>IG</option><option>WhatsApp</option><option>Threads</option></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="receiver" placeholder="收件人" class="border-b p-2 outline-none">
                        <input type="text" id="phone" placeholder="電話" class="border-b p-2 outline-none">
                    </div>
                    <textarea id="fullAddress" placeholder="地址..." class="w-full border p-3 rounded-xl h-20 text-xs bg-gray-50 outline-none"></textarea>
                </div>
                <div class="space-y-4">
                    <p class="font-bold text-gray-400 text-[10px] uppercase tracking-widest">商品明細</p>
                    <div id="itemsContainer" class="space-y-3">
                        <div class="item-row bg-gray-50 p-4 rounded-2xl border border-gray-100">
                            <input type="text" placeholder="商品名稱" class="prodName w-full mb-3 p-2 rounded-lg border text-sm outline-none">
                            <div class="grid grid-cols-3 gap-2">
                                <select class="prodLoc border p-2 rounded-lg text-[11px] bg-white">
                                    <option value="蝦皮">蝦皮</option><option value="7-11">7-11</option><option value="全家">全家</option><option value="宅配">宅配</option>
                                </select>
                                <input type="number" placeholder="金額" class="prodAmt border p-2 rounded-lg text-[11px]">
                                <select class="prodPayment border p-2 rounded-lg text-[11px] bg-white"><option value="已付">已付</option><option value="到付">到付</option></select>
                            </div>
                        </div>
                    </div>
                    <button id="submitBtn" onclick="submitOrder()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg">提交訂單</button>
                </div>
            </div>
        </section>

        <section id="cardContainer" class="grid gap-6"></section>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycby5vPRE71thYhYY-4XDMZ2oByLBsaZmy_FQPHzjHvAthhCTFmUCC29SycppE4d7pJ4mWA/exec";
        let allData = [];
        let currentMode = 'active';

        window.onload = loadOrders;

        function switchView(mode) {
            currentMode = mode;
            document.getElementById('btn-active').className = mode === 'active' ? "bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold" : "bg-gray-200 text-gray-600 px-4 py-2 rounded-xl text-xs font-bold";
            document.getElementById('btn-history').className = mode === 'history' ? "bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-bold" : "bg-gray-200 text-gray-600 px-4 py-2 rounded-xl text-xs font-bold";
            document.querySelectorAll('.active-only').forEach(el => el.style.display = mode === 'active' ? 'block' : 'none');
            renderOrders();
        }

        async function loadOrders() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = "<div class='text-center py-10 text-gray-400 animate-pulse'>更新數據中...</div>";
            const res = await fetch(GAS_URL);
            allData = await res.json();
            renderOrders();
        }

        function renderOrders() {
            const container = document.getElementById('cardContainer');
            const summaryBox = document.getElementById('summary-container');
            
            // 處理統計 (只計未完成且有取貨點的貨)
            const summary = { "蝦皮": [], "7-11": [], "全家": [], "宅配": [] };
            allData.forEach(item => {
                if (item.status !== '已取貨' && item.status !== '已寄出' && summary[item.location]) {
                    summary[item.location].push(item.product);
                }
            });
            summaryBox.innerHTML = Object.keys(summary).map(loc => `
                <div class="bg-white/10 p-3 rounded-xl border border-white/20">
                    <p class="text-[10px] font-bold opacity-60">${loc}</p>
                    <p class="text-xl font-black">${summary[loc].length}</p>
                    <p class="text-[9px] mt-1 opacity-50 truncate">${summary[loc].slice(0,2).join(', ')}...</p>
                </div>
            `).join('');

            // 分組數據
            const groups = allData.reduce((acc, obj) => {
                if (!acc[obj.name]) acc[obj.name] = [];
                acc[obj.name].push(obj);
                return acc;
            }, {});

            container.innerHTML = "";
            Object.keys(groups).reverse().forEach(name => {
                const items = groups[name];
                const first = items[0];
                
                // 判斷是否為歷史訂單 (假設運單編號在 M 欄，這裡對應 trackingNum)
                // 註：你需要在 GAS 讀取時加入 trackingNum: r[12]
                const hasTracking = items.some(i => i.trackingNum && i.trackingNum !== "");

                if (currentMode === 'active' && hasTracking) return;
                if (currentMode === 'history' && !hasTracking) return;

                // 判斷是否全部齊貨 (全部都是 已取貨 或 已寄出)
                const isAllReady = items.every(i => i.status === '已取貨' || i.status === '已寄出');

                const card = document.createElement('div');
                card.className = `bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden ${isAllReady && currentMode === 'active' ? 'all-ready' : ''}`;
                
                let itemsHTML = items.map(item => `
                    <div class="status-${item.status} p-3 mb-2 rounded-r-lg border border-gray-50 text-xs shadow-sm bg-white">
                        <div class="flex items-center mb-2">
                            <span class="loc-${item.location || 'default'} text-[9px] px-1.5 py-0.5 rounded mr-2 font-bold">${item.location}</span>
                            <span class="font-bold flex-1">${item.product}</span>
                            <span class="badge-${item.status} text-[9px] px-2 py-0.5 rounded-full font-bold">${item.status}</span>
                        </div>
                        <div class="flex justify-between items-end mt-2">
                            <input type="date" value="${item.date ? item.date.replace(/\//g, '-') : ''}" onchange="updateRow(${item.rowNum}, {date: this.value})" class="border rounded p-1 text-[10px] outline-none">
                            <select onchange="updateRow(${item.rowNum}, {status: this.value})" class="border rounded p-1 text-[10px] bg-white outline-none">
                                <option value="待取貨" ${item.status==='待取貨'?'selected':''}>待取貨</option>
                                <option value="已取貨" ${item.status==='已取貨'?'selected':''}>已取貨</option>
                                <option value="已寄出" ${item.status==='已寄出'?'selected':''}>已寄出</option>
                            </select>
                        </div>
                    </div>
                `).join('');

                card.innerHTML = `
                    <div class="p-4 bg-gray-50/50 border-b flex justify-between items-center">
                        <div><b class="text-gray-800">${name}</b> ${isAllReady && currentMode === 'active' ? '<span class="ml-2 text-[10px] bg-red-500 text-white px-2 py-0.5 rounded-full animate-pulse">齊貨</span>' : ''}</div>
                        <button onclick="copyData('${first.receiver}\\n${first.phone}\\n${first.fullAddress}')" class="text-[10px] bg-blue-600 text-white px-3 py-1.5 rounded-lg font-bold">複製資料</button>
                    </div>
                    <div class="p-4 grid md:grid-cols-2 gap-4">
                        <div class="text-xs space-y-2">
                            <div class="bg-gray-100 p-3 rounded-xl border border-dashed border-gray-300">
                                <p class="font-bold">${first.receiver}</p><p>${first.phone}</p><p class="text-gray-500 mt-1">${first.fullAddress}</p>
                            </div>
                            <div class="mt-4">
                                <p class="text-[9px] font-bold text-gray-400 uppercase mb-1">運單編號 (填入後移至歷史)</p>
                                <div class="flex space-x-1">
                                    <input type="text" id="track-${first.rowNum}" placeholder="輸入SF編號" value="${first.trackingNum || ''}" class="flex-1 border p-2 rounded-lg text-xs outline-none focus:border-blue-500">
                                    <button onclick="saveTracking(${first.rowNum}, '${name}')" class="bg-gray-800 text-white px-3 rounded-lg text-xs">儲存</button>
                                </div>
                            </div>
                        </div>
                        <div>${itemsHTML}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function updateRow(rowNum, data) {
            // 這個函數處理日期或狀態更新
            const payload = { 
                action: "updateStatus", 
                rowNum, 
                newStatus: data.status || allData.find(i => i.rowNum === rowNum).status,
                pickupDate: data.date ? data.date.replace(/-/g, '/') : allData.find(i => i.rowNum === rowNum).date
            };
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' });
            setTimeout(loadOrders, 500);
        }

        async function saveTracking(rowNum, name) {
            const trackVal = document.getElementById(`track-${rowNum}`).value;
            if(!trackVal) return alert("請輸入編號");
            
            // 這裡需要 GAS 同時支持更新第 13 欄 (運單編號)
            const payload = { action: "saveTracking", customerName: name, trackingNum: trackVal };
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' });
            alert("已儲存並移至歷史訂單");
            loadOrders();
        }

        function copyData(text) {
            navigator.clipboard.writeText(text).then(() => alert("已複製"));
        }

        async function submitOrder() {
            // (保持原有 submitOrder 邏輯，但在結束時呼叫 loadOrders)
        }
        
        function addItemRow() {
            const container = document.getElementById('itemsContainer');
            const row = container.querySelector('.item-row').cloneNode(true);
            row.querySelectorAll('input').forEach(i => i.value = '');
            container.appendChild(row);
        }
    </script>
</body>
</html>
