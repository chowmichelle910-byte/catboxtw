<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>ğŸ‡¹ğŸ‡¼ å°ç£-è¨‚å–®ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input, select, textarea { font-size: 16px !important; }
        .box-å¾…é è³¼ { border-left: 5px solid #EC4899; background-color: #FDF2F8; }
        .box-å¾…å–è²¨ { border-left: 5px solid #F59E0B; background-color: #FFFBEB; }
        .box-å·²å–è²¨ { border-left: 5px solid #10B981; background-color: #F0FDF4; }
        .box-å·²å¯„å‡º { border-left: 5px solid #9CA3AF; background-color: #F9FAFB; opacity: 0.8; }
        .card-ready-to-ship { border: 3px solid #EF4444 !important; background-color: #FEF2F2 !important; order: -1; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; font-weight: 900; }
        .source-IG { background-color: #E1306C; }
        .source-WhatsApp { background-color: #22C55E; }
        .source-Threads { background-color: #000000; }
        #loadingOverlay { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(255,255,255,0.7); flex-direction: column; align-items: center; justify-content: center; }
        .nav-active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: #2563eb; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        /* å¼·åˆ¶ä¿®æ­£ Status ä¸‹æ‹‰é¸å–®çš„é¡è‰²èˆ‡å­—é«” */
    select[onchange*="status"], 
    select[onchange*="updateRowField"] {
        background-color: #FFFFFF !important; /* å¼·åˆ¶èƒŒæ™¯ç‚ºç´”ç™½è‰² */
        color: #1F2937 !important;            /* å¼·åˆ¶æ–‡å­—ç‚ºæ·±ç°è‰²/é»‘è‰² (Slate-800) */
        font-size: 10px !important;           /* èª¿æ•´å­—é«”å¤§å° */
        font-weight: 900 !important;
        border: 1px solid #E5E7EB !important; /* åŠ å…¥æ·ºç°è‰²é‚Šæ¡† */
        padding: 2px 6px !important;
        border-radius: 8px !important;
        appearance: auto !important;          /* ç¢ºä¿é¡¯ç¤ºä¸‹æ‹‰ç®­é ­ */
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05) !important;
    }

    /* é‡å°é»‘è‰²å€åŸŸå…§çš„é¸å–®ç‰¹åˆ¥å„ªåŒ– */
    #filter-items-list select {
        background-color: #1e293b !important; /* é»‘æ¡†å…§çš„é¸å–®æ”¹ç”¨æ·±è—èƒŒæ™¯ */
        color: #60a5fa !important;            /* æ–‡å­—æ”¹ç”¨æ·ºè—è‰² */
        border-color: #334155 !important;
    }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-20 text-gray-900 font-sans">

    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
        <p class="mt-4 font-bold text-blue-600 text-sm">æ­£åœ¨è™•ç†ï¼Œè«‹ç¨å€™...</p>
    </div>

    <div class="max-w-6xl mx-auto p-4 space-y-6">
        <div class="flex flex-col md:flex-row items-center justify-between bg-white p-5 rounded-3xl shadow-sm border border-gray-100 gap-4">
            <h1 class="text-xl font-black text-gray-800 tracking-tight">ğŸ‡¹ğŸ‡¼ å°ç£-è¨‚å–®ç®¡ç†</h1>
            <nav class="flex bg-gray-100 p-1 rounded-2xl shadow-inner">
                <button onclick="switchView('active')" id="nav-active" class="px-4 py-2 rounded-lg text-xs font-black transition-all nav-active">é€²è¡Œä¸­</button>
                <button onclick="switchView('history')" id="nav-history" class="px-4 py-2 rounded-lg text-xs font-black transition-all text-gray-400">æ­·å²</button>
                <button onclick="switchView('profit')" id="nav-profit" class="px-4 py-2 rounded-lg text-xs font-black transition-all text-gray-400">ğŸ’° åˆ©æ½¤</button>
            </nav>
        </div>

        <section id="black-box-section" class="bg-slate-900 p-6 rounded-[2.5rem] shadow-2xl text-white">
            <div id="summary-container" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
            <div id="filter-details" class="hidden mt-6 pt-6 border-t border-white/10">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="filter-title" class="text-sm font-bold text-blue-400 italic"></h3>
                    <button onclick="closeFilter()" class="text-[10px] bg-white/10 px-3 py-1 rounded-full border border-white/20">é—œé–‰</button>
                </div>
                <div id="filter-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
            </div>
        </section>

        <section id="add-section" class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="space-y-4">
                    <p class="font-black text-gray-300 text-[11px] uppercase tracking-widest">å®¢æˆ¶è³‡è¨Š (Customer)</p>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="custName" placeholder="å®¢æˆ¶åç¨±" class="border-b-2 border-gray-100 focus:border-blue-500 p-2 text-sm font-bold outline-none transition-all">
                        <select id="source" class="border-b-2 border-gray-100 p-2 text-sm font-bold bg-white outline-none">
                            <option>IG</option><option>WhatsApp</option><option>Threads</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="receiver" placeholder="æ”¶ä»¶äºº" class="border-b-2 border-gray-100 focus:border-blue-500 p-2 text-sm font-bold outline-none">
                        <input type="text" id="phone" placeholder="é›»è©±" class="border-b-2 border-gray-100 focus:border-blue-500 p-2 text-sm outline-none">
                    </div>
                    <div class="space-y-2 pt-2">
                        <div class="flex gap-2">
                            <input type="text" id="sfCode" placeholder="è¼¸å…¥é †è±åº—ç¢¼ (å¦‚ 852TAL)" class="flex-1 border-b-2 border-gray-100 focus:border-blue-500 p-2 text-xs font-bold outline-none bg-blue-50/30">
                            <button onclick="searchSF()" class="bg-slate-800 text-white px-4 py-1 rounded-xl text-[10px] font-black hover:bg-black transition-all">ğŸ” æœå°‹åœ°å€</button>
                        </div>
                        <textarea id="fullAddress" placeholder="æœå°‹å¾Œè‡ªå‹•å¡«å…¥æˆ–æ‰‹å‹•è¼¸å…¥è©³ç´°åœ°å€..." class="w-full border-2 border-gray-50 p-4 rounded-3xl h-24 text-xs bg-gray-50 outline-none focus:bg-white focus:border-blue-100 transition-all"></textarea>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <p class="font-black text-gray-300 text-[11px] uppercase tracking-widest">å•†å“æ˜ç´° (Products)</p>
                        <button onclick="addItemRow()" class="text-blue-600 text-[11px] font-black hover:scale-105 transition-transform">+ å¢åŠ å“é …</button>
                    </div>
                    <div id="itemsContainer" class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                        <div class="item-row bg-gray-50 p-4 rounded-3xl border border-gray-100 relative mb-4">
    <button onclick="removeRow(this)" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-[10px] font-black shadow-lg hover:bg-red-600 transition-all z-10 flex items-center justify-center">âœ•</button>
    
    <input type="text" placeholder="å•†å“åç¨±" class="prodName w-full mb-3 p-3 rounded-2xl border-none shadow-sm text-sm font-bold">
                            <div class="grid grid-cols-3 gap-2">
                                <select onchange="togglePreDate(this)" class="prodLoc border-none shadow-sm p-3 rounded-2xl text-[12px] font-bold">
                                    <option>è¦çš®</option><option>7-11</option><option>å…¨å®¶</option><option>å®…é…</option><option>7ä»”é è³¼</option>
                                </select>
                                <input type="number" placeholder="é‡‘é¡" class="prodAmt border-none shadow-sm p-3 rounded-2xl text-[12px] font-bold">
                                <select class="prodPayment border-none shadow-sm p-3 rounded-2xl text-[12px] font-bold">
                                    <option>å·²ä»˜</option><option>åˆ°ä»˜</option><option>å¾…ä»˜</option>
                                </select>
                            </div>
                            <div class="pre-dates hidden grid grid-cols-2 gap-2 mt-3">
                                <div><label class="text-[9px] text-gray-400 ml-2">é è³¼æ—¥æœŸ</label><input type="date" class="pStart w-full border-none shadow-sm p-2 rounded-xl text-[11px]"></div>
                                <div><label class="text-[9px] text-gray-400 ml-2">å–è²¨æ—¥æœŸ</label><input type="date" class="pEnd w-full border-none shadow-sm p-2 rounded-xl text-[11px]"></div>
                            </div>
                        </div>
                    </div>
                    <button onclick="submitOrder()" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all">å„²å­˜ä¸¦å»ºç«‹è¨‚å–®</button>
                </div>
            </div>
        </section>

        <div id="cardContainer" class="flex flex-col gap-6"></div>

        <div id="profitSection" class="hidden space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-6 rounded-[2.5rem] border shadow-sm">
                <div><label class="text-[10px] font-black text-gray-400 uppercase ml-2">é¸æ“‡çµ±è¨ˆæœˆä»½</label><select id="profitMonthFilter" onchange="renderProfit()" class="w-full border-none bg-gray-100 rounded-2xl px-5 py-3 font-bold mt-1 outline-none"></select></div>
                <div><label class="text-[10px] font-black text-gray-400 uppercase ml-2">æœ¬æœˆåŒ¯ç‡ (HKD â¡ï¸ TWD)</label><div class="flex gap-2 mt-1"><input type="number" id="monthlyRateInput" step="0.01" class="w-full border-none bg-gray-100 rounded-2xl px-5 py-3 font-bold outline-none"><button onclick="saveMonthlyRate()" class="bg-blue-600 text-white px-8 rounded-2xl text-xs font-black shadow-md">å„²å­˜åŒ¯ç‡</button></div></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
                    <p class="text-white/40 text-[11px] font-black uppercase tracking-widest">è©²æœˆç¸½ç‡Ÿæ¥­é¡ (TWD)</p><p id="totalProfit" class="text-4xl font-black text-blue-400 mt-2">$0</p>
                    <div class="mt-6 pt-6 border-t border-white/10"><p class="text-white/40 text-[11px] font-black uppercase tracking-widest">é ä¼°ç¸½ç´”åˆ© (HKD)</p><p id="totalIncomeHKD" class="text-3xl font-black text-green-400 mt-2">$0</p></div>
                </div>
                <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 flex flex-col justify-center shadow-sm text-center"><p class="text-gray-400 text-[11px] font-black uppercase tracking-widest">æœ¬æœˆå®Œæˆå–®æ•¸</p><p id="totalOrders" class="text-4xl font-black text-gray-800 mt-2">0</p></div>
            </div>
            <div class="bg-white rounded-[2.5rem] border border-gray-100 overflow-hidden shadow-sm"><table class="w-full text-left text-sm"><thead class="bg-gray-50 border-b"><tr><th class="p-5 font-black text-gray-400">æ—¥æœŸ</th><th class="p-5 font-black text-gray-400">å®¢æˆ¶åç¨±</th><th class="p-5 font-black text-gray-400">å•†å“</th><th class="p-5 font-black text-gray-400 text-right">é‡‘é¡ (TWD)</th></tr></thead><tbody id="profitTableBody"></tbody></table></div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycby5vPRE71thYhYY-4XDMZ2oByLBsaZmy_FQPHzjHvAthhCTFmUCC29SycppE4d7pJ4mWA/exec";
        let allData = [];
        let currentMode = 'active';

        window.onload = loadOrders;
        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

        async function loadOrders() {
            showLoading(true);
            try {
                const res = await fetch(GAS_URL);
                allData = await res.json();
                initMonthFilter();
                updateSummaryUI();
                renderUI();
            } catch (e) { alert("è®€å–å¤±æ•—"); }
            showLoading(false);
        }

        function switchView(mode) {
            currentMode = mode;
            const activeSection = document.getElementById('add-section');
            const blackBox = document.getElementById('black-box-section');
            const profitSection = document.getElementById('profitSection');
            const cardContainer = document.getElementById('cardContainer');

            if(activeSection) activeSection.style.display = (mode === 'active' ? 'block' : 'none');
            if(blackBox) blackBox.style.display = (mode === 'active' ? 'block' : 'none');
            if(cardContainer) cardContainer.style.display = (mode === 'active' || mode === 'history') ? 'flex' : 'none';
            if(profitSection) profitSection.classList.toggle('hidden', mode !== 'profit');

            const btns = { 'active': 'nav-active', 'history': 'nav-history', 'profit': 'nav-profit' };
            Object.keys(btns).forEach(key => {
                const el = document.getElementById(btns[key]);
                if(el) el.className = `px-4 py-2 rounded-lg text-xs font-black transition-all ${key === mode ? 'nav-active' : 'text-gray-400'}`;
            });

            if (mode === 'profit') renderProfit();
            else renderOrders();
        }

        function renderUI() {
            if (currentMode === 'profit') renderProfit();
            else renderOrders();
        }

        function renderOrders() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = "";
            const groups = allData.reduce((acc, obj) => { if (!acc[obj.name]) acc[obj.name] = []; acc[obj.name].push(obj); return acc; }, {});
            
            Object.keys(groups).forEach(name => {
                const items = groups[name].filter(i => currentMode === 'active' ? !i.fullAddress.includes("é‹å–®:") : i.fullAddress.includes("é‹å–®:"));
                if (items.length === 0) return;

                const isAllReady = items.every(i => i.status === 'å·²å–è²¨');
                const first = items[0];
                const card = document.createElement('div');
                card.className = `bg-white rounded-[2rem] shadow-sm border ${isAllReady && currentMode === 'active' ? 'card-ready-to-ship' : 'border-gray-100'}`;
                
                let trackingNum = "";
                if (first.fullAddress.includes("é‹å–®:")) {
                    trackingNum = first.fullAddress.split("é‹å–®:")[1].replace(")", "").trim();
                }

                card.innerHTML = `
                    <div class="p-5 ${isAllReady && currentMode==='active' ? 'bg-red-50/50' : 'bg-gray-50/30'} border-b flex justify-between items-center">
                        <div class="flex flex-col">
                            <span class="source-${first.source} badge uppercase w-max mb-1" style="transform: scale(0.85); transform-origin: left;">${first.source}</span>
                            <b class="text-lg font-black text-gray-800 leading-none">${name}</b>
                        </div>
                        <div class="flex gap-1.5">
                            ${currentMode === 'history' && trackingNum ? `<button onclick="copyReplyText('${trackingNum}')" class="bg-indigo-600 text-white text-[9px] px-3 py-1.5 rounded-xl font-black">ğŸ“‹ å›è¦†</button>` : ''}
                            ${currentMode === 'active' ? `<button onclick="addMoreItems('${name}')" class="bg-green-600 text-white text-[9px] px-3 py-1.5 rounded-xl font-black">â• åŠ å–®</button>` : ''}
                            <button onclick="copyData('${first.receiver}\\n${first.phone}\\n${first.fullAddress}')" class="bg-blue-600 text-white text-[9px] px-3 py-1.5 rounded-xl font-black">è¤‡è£½åœ°å€</button>
                            <button onclick="deleteGroup('${name}')" class="text-red-400 text-[9px] border border-red-100 px-2 py-1 rounded-xl">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div class="p-5 grid md:grid-cols-2 gap-4">
                        <div class="text-[11px] font-bold space-y-2 text-gray-600">
    <p>ğŸ‘¤ ${first.receiver} / ğŸ“ ${first.phone}</p>
    
    <div class="group">
        <p class="text-gray-400 italic">ğŸ“ ${first.fullAddress}</p>
        <button onclick="editAddress('${name}', '${first.fullAddress.replace(/'/g, "\\'")}')" 
                class="text-blue-500 text-[9px] font-black underline mt-1">
            âœï¸ ä¿®æ”¹åœ°å€
        </button>
    </div>

    ${currentMode === 'active' ? `
        <div class="flex gap-2 pt-2 border-t mt-2">
            <input type="text" id="track-${first.rowNum}" placeholder="è¼¸å…¥å–®è™Ÿ" class="flex-1 border p-2 rounded-xl text-xs">
            <button onclick="shipOrder(${first.rowNum}, '${name}')" class="bg-slate-800 text-white px-4 rounded-xl text-[10px] font-black">å¯„å‡º</button>
        </div>` : ''}
</div>
                        <div class="space-y-2">${items.map(item => `
                            <div class="box-${item.status} p-2.5 rounded-xl border text-[10px]">
                                <div class="flex justify-between font-black"><span class="text-gray-800">${item.product}</span><span class="text-pink-600">${item.date || ''}</span></div>
                                <div class="flex justify-between items-center mt-1.5">
                                    <div class="text-blue-600 font-black">$${item.amount} (${item.location})</div>
${currentMode==='active' ? 
    `<select onchange="updateRowField(${item.rowNum}, 'status', this.value)" 
             class="border-none rounded-lg px-1 py-0.5 text-[8px] font-black text-gray-700 bg-white shadow-sm ring-1 ring-gray-100 scale-85 origin-right outline-none">
        <option value="å¾…é è³¼" ${item.status==='å¾…é è³¼'?'selected':''}>å¾…é è³¼</option>
        <option value="å¾…å–è²¨" ${item.status==='å¾…å–è²¨'?'selected':''}>å¾…å–è²¨</option>
        <option value="å·²å–è²¨" ${item.status==='å·²å–è²¨'?'selected':''}>å·²å–è²¨</option>
    </select>` 
    : `<span class="font-black text-gray-400 uppercase text-[9px] tracking-tighter">${item.status}</span>`
}
                                </div>
                            </div>`).join('')}</div>
                    </div>`;
                container.appendChild(card);
            });
        }

        async function searchSF() {
            const code = document.getElementById('sfCode').value.trim();
            if (!code) return alert("è«‹è¼¸å…¥åº—ç¢¼æˆ–åç¨±");
            showLoading(true);
            try {
                const resp = await fetch(`${GAS_URL}?action=searchSF&code=${encodeURIComponent(code)}`);
                const result = await resp.json();
                if (result.found) {
                    document.getElementById('fullAddress').value = result.address;
                    document.getElementById('sfCode').value = ""; 
                } else { alert("âŒ æ‰¾ä¸åˆ°è©²åœ°é»"); }
            } catch (e) { alert("æœå°‹å‡ºéŒ¯"); }
            showLoading(false);
        }

        function copyReplyText(track) {
            const text = `ä½ å¥½ï½è²¨ä»¶å·²æº–å‚™å¥½å¯„å‡ºï¼Œâ€å®¢äººå¯ä»¥æ–¼è½æ—¥å˜…ä¸‹åˆæ™‚é–“åˆ©ç”¨ä»¥ä¸‹é‹å–®è™Ÿç¢¼æŸ¥é–±ğŸ™‡ğŸ»â€â™€ï¸\n\n${track}\n\nè¬è¬ğŸ™ğŸ»ğŸ™ğŸ»`;
            navigator.clipboard.writeText(text).then(() => alert("âœ… å·²è‡ªå‹•è¤‡è£½å›è¦†èªå¥ï¼"));
        }

        async function shipOrder(rowNum, name) {
            const track = document.getElementById(`track-${rowNum}`).value;
            if(!track) return alert("è«‹è¼¸å…¥é‹å–®è™Ÿ");
            showLoading(true);
            const items = allData.filter(i => i.name === name && !i.fullAddress.includes("é‹å–®:"));
            for (let i of items) { 
                await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "updateField", rowNum: i.rowNum, field: 'status', value: 'å·²å¯„å‡º', tracking: track }), mode: 'no-cors' }); 
            }
            copyReplyText(track);
            loadOrders();
        }
        async function editAddress(customerName, oldAddress) {
    const newAddress = prompt("è«‹è¼¸å…¥æ–°åœ°å€ï¼š", oldAddress);
    // å¦‚æœå–æ¶ˆã€æ²’æ”¹ã€æˆ–è¼¸å…¥ç©ºç™½ï¼Œå‰‡ä¸åŸ·è¡Œ
    if (newAddress === null || newAddress === oldAddress || newAddress.trim() === "") return;

    showLoading(true);
    try {
        // ç¯©é¸å‡ºè©²å®¢æˆ¶æ‰€æœ‰å°šæœªå¯„å‡ºçš„é …ç›® (é¿å…æ”¹åˆ°æ­·å²ç´€éŒ„)
        const targets = allData.filter(i => i.name === customerName && !i.fullAddress.includes("é‹å–®:"));
        
        // ä½¿ç”¨ loop æ›´æ–°æ¯ä¸€è¡Œ
        for (let i of targets) {
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: "updateField",
                    rowNum: i.rowNum,
                    field: 'fullAddress',
                    value: newAddress
                }),
                mode: 'no-cors'
            });
        }
        // æ›´æ–°å®Œå¾Œé‡æ–°è¼‰å…¥
        setTimeout(loadOrders, 800);
    } catch (e) {
        alert("æ›´æ–°åœ°å€æ™‚å‡ºéŒ¯");
        showLoading(false);
    }
}

        function addMoreItems(name) {
            const data = allData.find(i => i.name === name);
            document.getElementById('custName').value = data.name;
            document.getElementById('source').value = data.source;
            document.getElementById('receiver').value = data.receiver;
            document.getElementById('phone').value = data.phone;
            document.getElementById('fullAddress').value = data.fullAddress;
            document.getElementById('add-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function submitOrder() {
            const name = document.getElementById('custName').value;
            if(!name) return alert("è«‹è¼¸å…¥å®¢æˆ¶");
            showLoading(true);
            const d = new Date();
            const currentMonth = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
            let autoRate = "";
            const match = allData.find(i => {
                const idate = new Date(i.orderDate);
                return (!isNaN(idate) && `${idate.getFullYear()}-${(idate.getMonth()+1).toString().padStart(2,'0')}` === currentMonth && i.monthlyRate);
            });
            if(match) autoRate = match.monthlyRate;

            const payload = {
                orderID: "TW"+d.getTime().toString().slice(-4), customerName: name, source: document.getElementById('source').value,
                receiver: document.getElementById('receiver').value, phone: document.getElementById('phone').value,
                fullAddress: document.getElementById('fullAddress').value,
                orderDate: `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`,
                monthlyRate: autoRate,
                items: Array.from(document.querySelectorAll('.item-row')).map(row => {
                    const loc = row.querySelector('.prodLoc').value;
                    const dateStr = loc==='7ä»”é è³¼' ? `(é :${row.querySelector('.pStart').value} æ”:${row.querySelector('.pEnd').value})` : "";
                    return { productName: row.querySelector('.prodName').value, pickupLocation: loc, amount: row.querySelector('.prodAmt').value, paymentStatus: row.querySelector('.prodPayment').value, status: loc==='7ä»”é è³¼'?'å¾…é è³¼':'å¾…å–è²¨', date: dateStr };
                })
            };
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' });
            setTimeout(() => location.reload(), 800);
        }

        async function updateRowField(r, f, v) { showLoading(true); await fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:"updateField",rowNum:r,field:f,value:v}),mode:'no-cors'}); setTimeout(loadOrders, 800); }
        async function saveMonthlyRate() { const m = document.getElementById('profitMonthFilter').value; const r = document.getElementById('monthlyRateInput').value; showLoading(true); await fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:"updateMonthlyRate",month:m,rate:r}),mode:'no-cors'}); alert("åŒ¯ç‡å·²åŒæ­¥"); setTimeout(loadOrders, 1000); }
        
        function updateSummaryUI() {
            const box = document.getElementById('summary-container');
            const s = { "è¦çš®":0, "7-11":0, "å…¨å®¶":0, "å®…é…":0, "7ä»”é è³¼":0 };
            allData.forEach(i => { if((i.status==='å¾…å–è²¨'||i.status==='å¾…é è³¼') && !i.fullAddress.includes("é‹å–®:")) if(s[i.location]!==undefined) s[i.location]++; });
            box.innerHTML = Object.keys(s).map(l => `<div onclick="filterStatDetail('${l}')" class="bg-white/5 p-4 rounded-3xl border border-white/10 cursor-pointer hover:bg-white/20 transition-all"><p class="text-[10px] opacity-40 uppercase font-black">${l}</p><p class="text-2xl font-black mt-1">${s[l]}</p></div>`).join('');
        }
        
        function filterStatDetail(loc) {
            const list = document.getElementById('filter-items-list');
            const filtered = allData.filter(i => i.location === loc && (i.status === 'å¾…å–è²¨' || i.status === 'å¾…é è³¼') && !i.fullAddress.includes("é‹å–®:"));
            document.getElementById('filter-details').classList.remove('hidden');
            document.getElementById('filter-title').innerText = `ğŸ” ${loc} (${filtered.length})`;
    
            // è£œå› select åˆ‡æ›åŠŸèƒ½ï¼Œä¸¦ç¸®å°å­—é«”
            list.innerHTML = filtered.map(i => `
                <div class="bg-white/10 p-3 rounded-2xl border border-white/10">
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-black text-xs text-blue-300">${i.name}</p>
                        <select onchange="updateRowField(${i.rowNum}, 'status', this.value)" 
                                class="bg-slate-800 text-[9px] rounded-lg border border-white/20 px-1 py-0.5 outline-none text-white scale-90 origin-right">
                            <option value="å¾…é è³¼" ${i.status === 'å¾…é è³¼' ? 'selected' : ''}>å¾…é è³¼</option>
                            <option value="å¾…å–è²¨" ${i.status === 'å¾…å–è²¨' ? 'selected' : ''}>å¾…å–è²¨</option>
                            <option value="å·²å–è²¨" ${i.status === 'å·²å–è²¨' ? 'selected' : ''}>å·²å–è²¨</option>
                        </select>
                    </div>
                    <p class="text-[10px] opacity-70">${i.product}</p>
                </div>`).join('');
        }
        
        function initMonthFilter() {
            const filter = document.getElementById('profitMonthFilter');
            const months = [...new Set(allData.map(i => { const d = new Date(i.orderDate); return isNaN(d) ? null : `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`; }))].filter(Boolean).sort().reverse();
            filter.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        
        function renderProfit() {
            const target = document.getElementById('profitMonthFilter').value;
            const rateInput = document.getElementById('monthlyRateInput');
            let total = 0, count = 0, rate = 0;
            const filtered = allData.filter(i => { const d = new Date(i.orderDate); const m = isNaN(d) ? "" : `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`; if (m === target && i.monthlyRate) rate = parseFloat(i.monthlyRate); return m === target; });
            rateInput.value = rate || "";
            document.getElementById('profitTableBody').innerHTML = filtered.map(i => { total += parseFloat(i.amount||0); count++; return `<tr class="border-b text-[12px]"><td class="p-5 opacity-60 font-bold">${i.orderDate}</td><td class="p-5 font-black text-gray-800">${i.name}</td><td class="p-5 text-gray-500">${i.product}</td><td class="p-5 text-right font-black text-blue-600">$${i.amount}</td></tr>`; }).join('');
            document.getElementById('totalProfit').innerText = `$${total.toLocaleString()}`;
            document.getElementById('totalOrders').innerText = count;
            if(rate > 0) document.getElementById('totalIncomeHKD').innerText = `$${((total/3.6)-(total/rate)).toFixed(2)}`;
            else document.getElementById('totalIncomeHKD').innerText = "æœªè¨­åŒ¯ç‡";
        }

        function togglePreDate(el) { el.closest('.item-row').querySelector('.pre-dates').classList.toggle('hidden', el.value!=='7ä»”é è³¼'); }
        function addItemRow() {
    const container = document.getElementById('itemsContainer');
    const rows = document.querySelectorAll('.item-row');
    const newRow = rows[0].cloneNode(true);
    
    // æ¸…ç©ºæ–°è¡Œçš„æ•¸å€¼
    newRow.querySelectorAll('input').forEach(i => i.value = '');
    newRow.querySelector('.pre-dates').classList.add('hidden');
    
    // ç¢ºä¿æ–°è¡Œçš„æŒ‰éˆ•é»æ“Šæ™‚èƒ½åˆªé™¤è‡ªå·±
    const deleteBtn = newRow.querySelector('button');
    deleteBtn.onclick = function() { removeRow(this); };
    
    container.appendChild(newRow);
}
        function removeRow(btn) {
    const rows = document.querySelectorAll('.item-row');
    if (rows.length > 1) {
        btn.closest('.item-row').remove();
    } else {
        alert("æœ€å°‘éœ€è¦ä¿ç•™ä¸€å€‹å•†å“å“é …");
    }
}
        function copyData(t) {
    if (!navigator.clipboard) {
        // å‚™ç”¨æ–¹æ¡ˆï¼šé‡å°èˆŠç‰ˆç€è¦½å™¨
        const textArea = document.createElement("textarea");
        textArea.value = t;
        document.body.appendChild(textArea);
        textArea.select();
        try { document.execCommand('copy'); alert("âœ… å·²è¤‡è£½åœ°å€è³‡æ–™"); } 
        catch (err) { alert("âŒ è¤‡è£½å¤±æ•—"); }
        document.body.removeChild(textArea);
        return;
    }
    navigator.clipboard.writeText(t).then(() => alert("âœ… å·²è¤‡è£½åœ°å€è³‡æ–™"));
}
        function closeFilter() { document.getElementById('filter-details').classList.add('hidden'); }
        async function deleteGroup(n) { if(!confirm(`ç¢ºå®šè¦å®Œå…¨åˆªé™¤ã€Œ${n}ã€ï¼Ÿ`)) return; showLoading(true); for(let i of allData.filter(i=>i.name===n)) await fetch(GAS_URL,{method:'POST',body:JSON.stringify({action:"deleteRow",rowNum:i.rowNum}),mode:'no-cors'}); setTimeout(loadOrders, 1000); }
    </script>
</body>
</html>
